# LLMストーリー生成設計書

## 1. 基本ストーリー生成（LLM_A）

### 1.1 入力パラメータ
- 名前（ひらがな）
- 名前の由来
- 親からのメッセージ
- 子供の性別・年齢（オプション）

### 1.2 ストーリー構造
1. プロローグ
   - 主人公の紹介
   - 冒険の動機付け
   - 最初の導き手との出会い

2. 展開（名前の文字数に応じて）
   - 各文字につき2ページ程度
   - 新しい導き手との出会い
   - 場面の変化と成長

3. エピローグ
   - 親からのメッセージの集大成
   - 名前の由来の意味の理解
   - 未来への希望

## 2. プロンプト設計

### 2.1 基本プロンプト構造
```
あなたは子供向け絵本作家です。以下の要素を使って、[名前]という子供のための
オリジナルストーリーを作成してください：

- 名前の由来：[由来]
- 親からのメッセージ：[メッセージ]
- ストーリーの特徴：
  * 主人公と導き手による地球冒険物語
  * 各シーンで異なる導き手（動物、自然現象、植物）が登場
  * 名前の由来とメッセージを物語に織り込む
  * [年齢]歳の子供が理解できる表現
```

### 2.2 制約条件
- 1ページあたり40文字程度
- ひらがな主体の文章
- 明確な情景描写
- 感情表現の適切な使用

## 3. ストーリー生成プロセス

### 3.1 名前の分析
1. 文字の分解
2. 各文字の特徴抽出
3. 関連するキャラクター候補の選定

### 3.2 メッセージの分析
1. キーワード抽出
2. 感情トーンの分析
3. テーマの特定

### 3.3 ストーリーライン構築
1. 全体の流れの設計
   - 起：主人公の紹介と動機
   - 承：冒険の開始と課題
   - 転：課題への取り組み
   - 結：成長と理解

2. 各シーンの展開
   - 場所の選定
   - 導き手の選択
   - メッセージの配置

## 4. 出力フォーマット

### 4.1 シーン情報
```json
{
  "scene_id": "数値",
  "location": "場所",
  "season": "季節",
  "guide": {
    "type": "導き手の種類",
    "name": "キャラクター名",
    "traits": ["特徴1", "特徴2"]
  },
  "message": {
    "theme": "テーマ",
    "content": "メッセージ内容"
  },
  "narrative": "ストーリーテキスト"
}
```

### 4.2 メタデータ
```json
{
  "story_structure": {
    "total_scenes": "シーン数",
    "main_themes": ["テーマ1", "テーマ2"],
    "character_progression": ["キャラクター1", "キャラクター2"]
  },
  "message_distribution": {
    "theme1": "出現回数",
    "theme2": "出現回数"
  }
}
```

## 5. 品質管理

### 5.1 評価基準
- 物語の一貫性
- メッセージの明確さ
- 年齢適合性
- 感情表現の適切さ

### 5.2 チェックポイント
1. 導き手の選択
   - 季節との整合性
   - メッセージとの関連性
   - キャラクター性の明確さ

2. 場面展開
   - 自然な流れ
   - 適切な盛り上がり
   - 分かりやすい展開

3. メッセージの伝達
   - 明確な表現
   - 適切な反復
   - 感動的な結末

## 6. エラー処理

### 6.1 再生成トリガー
- 一貫性スコアが閾値未満
- メッセージの重複過多
- 展開の不自然さ

### 6.2 調整パラメータ
- 文章の複雑さ
- 感情表現の強度
- 展開の速度

## 7. 実装例

### 7.1 基本シーン生成
```python
def generate_scene(name_char, message_theme, previous_scene=None):
    # 導き手の選択
    guide = select_guide(name_char, message_theme)
    
    # 場所と季節の決定
    location, season = select_stage(guide, previous_scene)
    
    # シーンの生成
    scene = {
        "guide": guide,
        "location": location,
        "season": season,
        "narrative": generate_narrative(guide, location, message_theme)
    }
    
    return scene
```

### 7.2 メッセージ組み込み
```python
def incorporate_message(scene, parent_message):
    # メッセージのキーワード抽出
    keywords = extract_keywords(parent_message)
    
    # 導き手のキャラクターに合わせたメッセージ変換
    adapted_message = adapt_message(
        message=parent_message,
        guide=scene["guide"],
        keywords=keywords
    )
    
    # ナラティブへの組み込み
    scene["narrative"] = weave_message(
        narrative=scene["narrative"],
        message=adapted_message
    )
    
    return scene
```

## 8. 統合フロー

1. 初期化
   - ユーザー入力の解析
   - 基本パラメータの設定
   - 制約条件の確認

2. ストーリー生成
   - プロローグの生成
   - 各文字のシーン生成
   - エピローグの生成

3. 最適化
   - 一貫性チェック
   - メッセージ分布の確認
   - 必要に応じた調整

4. 出力
   - JSONフォーマットでの出力
   - メタデータの付加
   - QUBOへの受け渡し
